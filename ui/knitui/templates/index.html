<%inherit file="base.html"/>
<%block name="title">Status</%block>

<div style="margin-bottom: 20px">
	<div class="show_without_connection" style="display:none">
		<img src="/static/img/icon_connerr.svg" id="connection_error">
	</div>
	<div class="show_with_connection" style="display:none">
		<button title="Carriage position calibration" class="menubutton btype-warning" id="carriage_pos_button"></button>
		<button title="Start/stop knitting" class="menubutton btype-play" onclick="action_stop_play()" id="play_button" />
		<button title="Carriage movement" class="menubutton btype-carriage-left" id="carriage_direction_button"></button>
		<button title="Repeat pattern" class="menubutton btype-repeat" onclick="action_repeat_oneshot()" id="repeat_button" />
		<button title="Hide bar" onmousedown="action_hide_bar(true)" onmouseup="action_hide_bar(false)" class="menubutton btype-eye" />
		<button title="Previous row" onclick="action_row_prev()" class="menubutton btype-prev" />
		<button title="Next row" onclick="action_row_next()" class="menubutton btype-next" />
		<button title="Reset skipped needle count" class="menubutton btype-skipcnt" id="skipped_needles_cnt"></button>
	</div>
</div>

<div class="grids-example" class="show_with_connection" style="position: relative; top: -10px;">
    <div class="pure-g">
        <div class="pure-u-1-3">
            <div class="l-box">
                <h4>Pattern Size</h4>
                <p id="pattern_size"></p>
             </div>
        </div>

        <div class="pure-u-1-3">
            <div class="l-box">
                <h4>Pattern Position</h4>
                <p id="pattern_pos"></p>
             </div>
        </div>
    </div>
</div>

<div>
	<img src="/static/img/needles.png" /><br />
	<img src="/static/img/arrow.png" id="carriage_position_arrow" style="position: relative; left: 0px; top: -10px" />
</div>
<div class="show_with_pattern" style="display:none">
	<div style="position: relative">
		<img src="/rest/pattern" onerror="pattern_available(false)" onload="pattern_available(true)" id="pattern" style="position: relative" />
		<img src="/static/img/darkbar.png" id="active_row_bar" style="position: absolute; left: -10px; top : 5px">
	</div>
</div>
<div class="show_without_pattern" style="display:none">
	No pattern loaded.
</div>

<script language="JavaScript">
const connection_error = document.getElementById("connection_error");
const skipped_needles_cnt = document.getElementById("skipped_needles_cnt");
const carriage_position_arrow = document.getElementById("carriage_position_arrow");
const carriage_pos_button = document.getElementById("carriage_pos_button");
const carriage_direction_button = document.getElementById("carriage_direction_button");
const have_pattern_loaded = document.getElementById("have_pattern_loaded");
const no_pattern_loaded = document.getElementById("no_pattern_loaded");
const active_row_bar = document.getElementById("active_row_bar");
const play_button = document.getElementById("play_button");
const repeat_button = document.getElementById("repeat_button");
const pattern = document.getElementById("pattern");
const pattern_size = document.getElementById("pattern_size");
const pattern_pos = document.getElementById("pattern_pos");
let last_status = null;

const row_sound = (localStorage.getItem("setting_row_sound") != 0) ? new Audio("/static/sound/ding.mp3") : null;
const pattern_finished_sound = new Audio("/static/sound/pattern_finished.mp3");

const websocket_uri = "ws://" + window.location.host + "/ws/status";
let websocket = null;

function offset_to_needle(offset) {
	if ((offset >= 0) && (offset < 100)) {
		return "Yellow " + (100 - offset);
	} else if ((offset >= 0) && (offset < 200)) {
		return "Green " + (offset - 99);
	} else {
		return "{" + offset + "}";
	}
}

function wsevent_onmessage(event) {
	const msg = JSON.parse(event.data);
	if (msg["msg_type"] == "connection_error") {
		connection_error.title = msg["text"];
		document.querySelectorAll(".show_with_connection").forEach(function(element) { element.style.display = "none"; });
		document.querySelectorAll(".show_without_connection").forEach(function(element) { element.style.display = ""; });
	} else if (msg["msg_type"] == "status") {
		if (msg["knitting_mode"] == "off") {
			play_button.classList.replace("btype-play", "btype-stop");
		} else if (msg["knitting_mode"] == "on") {
			play_button.classList.replace("btype-stop", "btype-play");
		} else {
			play_button.classList.remove("btype-stop");
			play_button.classList.remove("btype-play");
		}
		if (msg["repeat_mode"] == "oneshot") {
			repeat_button.classList.replace("btype-repeat", "btype-oneshot");
			repeat_button.classList.replace("btype-manual", "btype-oneshot");
		} else if (msg["repeat_mode"] == "repeat") {
			repeat_button.classList.replace("btype-oneshot", "btype-repeat");
			repeat_button.classList.replace("btype-manual", "btype-repeat");
		} else if (msg["repeat_mode"] == "manual") {
			repeat_button.classList.replace("btype-oneshot", "btype-manual");
			repeat_button.classList.replace("btype-repeat", "btype-manual");
		} else {
			repeat_button.classList.remove("btype-oneshot");
			repeat_button.classList.remove("btype-repeat");
			repeat_button.classList.remove("btype-manual");
		}

		document.querySelectorAll(".show_with_connection").forEach(function(element) { element.style.display = ""; });
		document.querySelectorAll(".show_without_connection").forEach(function(element) { element.style.display = "none"; });
		skipped_needles_cnt.innerHTML = msg["skipped_needles_cnt"];

		ypos = -10 + (msg["pattern_row"] * 5);
		active_row_bar.style.top = ypos + "px";

		const xshift = 5 * msg["pattern_offset"];
		pattern.style.left = xshift + "px";

		if (msg["carriage_position_valid"]) {
			const pixel_pos = (msg["carriage_position"] * 4.95);
			carriage_position_arrow.title = "Needle " + msg["carriage_position"] + ", " + offset_to_needle(msg["carriage_position"]);
			carriage_position_arrow.style.left = pixel_pos + "px";
			if ((pattern_finished_sound != null) && (last_status != null) && (last_status["knitting_mode"] == "on") && (msg["knitting_mode"] == "off")) {
				/* Machine shut off */
				pattern_finished_sound.play();
			} else if ((row_sound != null) && (last_status != null) && (last_status["carriage_position_valid"]) && (last_status["pattern_row"] != msg["pattern_row"])) {
				/* Row advanced */
				row_sound.play();
			}
			carriage_position_arrow.style.display = "";
			carriage_pos_button.classList.replace("btype-warning", "btype-checkmark");
		} else {
			carriage_position_arrow.style.display = "none";
			carriage_pos_button.classList.replace("btype-checkmark", "btype-warning");
		}

		if (msg["carriage_position_valid"] && (msg["knitting_mode"] == "on")) {
			carriage_direction_button.style.display = "";

			const is_even_row = ((msg["pattern_row"] % 2) == 0);
			if (msg["even_rows_left_to_right"] == is_even_row) {
				carriage_direction_button.classList.replace("btype-carriage-left", "btype-carriage-right");
			} else {
				carriage_direction_button.classList.replace("btype-carriage-right", "btype-carriage-left");
			}
		} else {
			carriage_direction_button.style.display = "none";
		}

		const real_width = msg["pattern_max_x"] - msg["pattern_min_x"] + 1;
		const real_height = msg["pattern_max_y"] - msg["pattern_min_y"] + 1;
		pattern_size.innerHTML = real_width + " x " + real_height;

		const real_offset_x = msg["pattern_min_x"] + msg["pattern_offset"];
		pattern_pos.innerHTML = offset_to_needle(real_offset_x) + " - " + offset_to_needle(real_offset_x + real_width - 1);


		last_status = msg;
	} else {
		console.log("Unknown message type: ", msg)
	}
}

function pattern_available(availibility) {
	document.querySelectorAll(availibility ? ".show_without_pattern" : ".show_with_pattern").forEach(function(element) { element.style.display = "none"; });
	document.querySelectorAll(availibility ? ".show_with_pattern" : ".show_without_pattern").forEach(function(element) { element.style.display = ""; });
}

function wsevent_onerror(event) {
	console.log("Websocket error:", event);
}

function wsevent_onclose(event) {
	console.log("Websocket closed:", event);
	setTimeout(function() { websocket = connect_websocket(websocket_uri); }, 1000);
}

function action_stop_play() {
	if (last_status != null) {
		let uri = null;
		if (last_status["knitting_mode"] == "on") {
			uri = "/rest/set_knitting_mode/off";
		} else if (last_status["knitting_mode"] == "off") {
			uri = "/rest/set_knitting_mode/on";
		} else {
			console.log("Unknown play/stop action.", last_status);
		}
		if (uri) {
			const request = new XMLHttpRequest();
			request.open("POST", uri, true);
			request.send();
		}
	}
}

function action_repeat_oneshot() {
	if (last_status != null) {
		let uri = null;
		if (last_status["repeat_mode"] == "oneshot") {
			uri = "/rest/set_repeat_mode/repeat";
		} else if (last_status["repeat_mode"] == "repeat") {
			uri = "/rest/set_repeat_mode/manual";
		} else if (last_status["repeat_mode"] == "manual") {
			uri = "/rest/set_repeat_mode/oneshot";
		} else {
			console.log("Unknown repeat action.", last_status);
		}
		if (uri) {
			const request = new XMLHttpRequest();
			request.open("POST", uri, true);
			request.send();
		}
	}
}

function action_row_set(pattern_row) {
	if (last_status != null) {
		if (last_status["repeat_mode"] == "repeat") {
			pattern_row = (pattern_row + last_status["pattern_height"]) % last_status["pattern_height"];
		}

		if ((pattern_row >= 0) && (pattern_row < last_status["pattern_height"])) {
			/* Set last row to expected row so we don't get beeping */
			last_status["pattern_row"] = pattern_row;

			const request = new XMLHttpRequest();
			request.open("POST", "/rest/pattern_row/" + pattern_row, true);
			request.send();
		}
	}
}

function action_row_inc(value) {
	if ((last_status != null) && (last_status["pattern_height"] > 0)) {
		const pattern_row = last_status["pattern_row"] + value;
		action_row_set(pattern_row);
	}
}

function action_offset_inc(value) {
	if ((last_status != null) && (last_status["pattern_height"] > 0)) {
		const new_offset = last_status["pattern_offset"] + value;

		const request = new XMLHttpRequest();
		request.open("POST", "/rest/pattern_offset/" + new_offset, true);
		request.send();
	}
}

function action_row_next() {
	action_row_inc(1);
}

function action_row_prev() {
	action_row_inc(-1);
}

function action_hide_bar(hide_bar) {
	active_row_bar.style.display = hide_bar ? "none" : "";
}

function connect_websocket(uri) {
	const websocket = new WebSocket(uri);
	websocket.onmessage = wsevent_onmessage;
	websocket.onerror = wsevent_onerror;
	websocket.onclose = wsevent_onclose;
	return websocket;
}

function keypress(key) {
	if (key.key == "ArrowUp") {
		action_row_inc(-1);
	} else if (key.key == "ArrowDown") {
		action_row_inc(1);
	} else if (key.key == "PageDown") {
		action_row_inc(5);
	} else if (key.key == "PageUp") {
		action_row_inc(-5);
	} else if (key.key == "Home") {
		action_row_set(0);
	} else if (key.key == "End") {
		if (last_status != null) {
			action_row_set(last_status["pattern_height"] - 1);
		}
	} else if (key.key == "ArrowLeft") {
		action_offset_inc(-1);
	} else if (key.key == "ArrowRight") {
		action_offset_inc(1);
	}
}

websocket = connect_websocket(websocket_uri);
document.onkeydown = keypress;
</script>
